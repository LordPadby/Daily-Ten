<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Ten - Maths Practice</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBE4WPAaP1WDsouo7VhWWhsVwOGGQWEdtY",
            authDomain: "daily-ten.firebaseapp.com",
            databaseURL: "https://daily-ten-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "daily-ten",
            storageBucket: "daily-ten.firebasestorage.app",
            messagingSenderId: "235458085383",
            appId: "1:235458085383:web:61d02b5d48bb8ce9e7e0a2"
        };

        // TEACHER PASSWORD - CHANGE THIS!
        const TEACHER_PASSWORD = "teacher2024";

        // Initialize Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();

        // Application State
        let state = {
            view: 'login',
            questions: { easy: [], medium: [], hard: [] },
            studentUsername: null,
            selectedDifficulty: null,
            selectedTopic: null,
            currentQuiz: [],
            answers: {},
            submitted: false,
            score: 0,
            studentProgress: [],
            showClearConfirm: false,
            clearLevel: null,
            usernameInput: '',
            teacherAuthenticated: false,
            analyticsView: 'overall', // 'overall' or 'by-level'
            selectedStudent: null
        };

        // Firebase Functions
        async function loadQuestions() {
            try {
                const snapshot = await database.ref('questions').once('value');
                if (snapshot.exists()) {
                    state.questions = snapshot.val();
                }
            } catch (error) {
                console.error('Error loading questions:', error);
            }
        }

        async function saveQuestions(level, questions) {
            try {
                await database.ref('questions/' + level).set(questions);
                state.questions[level] = questions;
            } catch (error) {
                console.error('Error saving questions:', error);
                alert('Error saving questions. Please try again.');
            }
        }

        async function saveProgress(username, quizData) {
            try {
                const userRef = database.ref('progress/' + username);
                const snapshot = await userRef.once('value');
                let userData = snapshot.val() || { username: username, attempts: [] };
                
                userData.attempts.push({
                    date: new Date().toISOString(),
                    level: quizData.level,
                    topic: quizData.topic || 'mixed',
                    score: quizData.score,
                    totalQuestions: 10,
                    questionDetails: quizData.questionDetails // Track individual question performance
                });
                
                await userRef.set(userData);
            } catch (error) {
                console.error('Error saving progress:', error);
            }
        }

        async function loadAllProgress() {
            try {
                const snapshot = await database.ref('progress').once('value');
                if (snapshot.exists()) {
                    state.studentProgress = Object.values(snapshot.val());
                } else {
                    state.studentProgress = [];
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                state.studentProgress = [];
            }
        }

        async function deleteStudentProgress(username) {
            try {
                await database.ref('progress/' + username).remove();
                await loadAllProgress();
                render();
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('Error deleting student data.');
            }
        }

        async function clearLevel(level) {
            try {
                await database.ref('questions/' + level).remove();
                state.questions[level] = [];
                state.showClearConfirm = false;
                state.clearLevel = null;
                render();
            } catch (error) {
                console.error('Error clearing questions:', error);
                alert('Error clearing questions.');
            }
        }

        // Helper Functions
        function getAllTopics() {
            const topics = new Set();
            ['easy', 'medium', 'hard'].forEach(function(level) {
                state.questions[level].forEach(function(q) {
                    if (q.Topic && q.Topic !== 'General') {
                        topics.add(q.Topic);
                    }
                });
            });
            return Array.from(topics).sort();
        }

        function getQuestionsByLevelAndTopic(level, topic) {
            return state.questions[level].filter(function(q) {
                return q.Topic === topic;
            });
        }

        function calculateTopicStats(attempts, level) {
            const topicStats = {};
            
            attempts.forEach(function(attempt) {
                if (level && attempt.level !== level) return;
                
                if (attempt.questionDetails) {
                    attempt.questionDetails.forEach(function(detail) {
                        const topic = detail.topic || 'Unknown';
                        if (!topicStats[topic]) {
                            topicStats[topic] = { correct: 0, total: 0 };
                        }
                        topicStats[topic].total++;
                        if (detail.correct) {
                            topicStats[topic].correct++;
                        }
                    });
                }
            });
            
            return topicStats;
        }

        // App Functions
        function generateQuiz(difficulty, topic) {
            let levelQuestions;
            
            if (topic) {
                levelQuestions = getQuestionsByLevelAndTopic(difficulty, topic);
                if (levelQuestions.length < 10) {
                    alert('Not enough ' + topic + ' questions in this level. Need at least 10.');
                    return;
                }
            } else {
                levelQuestions = state.questions[difficulty];
                if (levelQuestions.length < 10) {
                    const levelNum = difficulty === 'easy' ? '1' : difficulty === 'medium' ? '2' : '3';
                    alert('You need at least 10 questions in Level ' + levelNum + ' to generate a quiz.');
                    return;
                }
            }
            
            const shuffled = levelQuestions.slice().sort(function() { return Math.random() - 0.5; });
            state.currentQuiz = shuffled.slice(0, 10);
            state.answers = {};
            state.submitted = false;
            state.selectedDifficulty = difficulty;
            state.selectedTopic = topic;
            state.view = 'student';
            render();
        }

        function handleAnswer(questionIndex, answer) {
            state.answers[questionIndex] = answer;
            render();
        }

        async function submitQuiz() {
            let correctCount = 0;
            const questionDetails = [];
            
            state.currentQuiz.forEach(function(q, idx) {
                const correct = state.answers[idx] === q.Answer;
                if (correct) correctCount++;
                
                questionDetails.push({
                    question: q.Question,
                    topic: q.Topic,
                    correct: correct,
                    studentAnswer: state.answers[idx],
                    correctAnswer: q.Answer
                });
            });
            
            state.score = correctCount;
            state.submitted = true;
            
            await saveProgress(state.studentUsername, {
                level: state.selectedDifficulty,
                topic: state.selectedTopic,
                score: correctCount,
                questionDetails: questionDetails
            });
            
            render();
        }

        function handleStudentLogin() {
            const username = state.usernameInput.trim();
            if (username.length < 2) {
                alert('Please enter a username with at least 2 characters');
                return;
            }
            state.studentUsername = username;
            state.view = 'difficulty-select';
            render();
        }

        async function addQuestionsFromText(level, text) {
            const lines = text.trim().split('\n');
            const newQuestions = [];
            
            for (let i = 0; i < lines.length; i++) {
                const parts = lines[i].split('\t');
                
                if (i === 0 && parts[0] && parts[0].toLowerCase().includes('question')) {
                    continue;
                }
                
                if (parts.length >= 7 && parts[0] && parts[0].trim()) {
                    newQuestions.push({
                        Question: parts[0].trim(),
                        'Option A': parts[1].trim(),
                        'Option B': parts[2].trim(),
                        'Option C': parts[3].trim(),
                        'Option D': parts[4].trim(),
                        Answer: parts[5].trim(),
                        Explanation: parts[6].trim(),
                        Topic: (parts[7] || 'General').trim()
                    });
                }
            }
            
            if (newQuestions.length > 0) {
                const levelNum = level === 'easy' ? '1' : level === 'medium' ? '2' : '3';
                await saveQuestions(level, state.questions[level].concat(newQuestions));
                alert('Added ' + newQuestions.length + ' questions to Level ' + levelNum + '!');
                render();
            } else {
                alert('No valid questions found. Make sure your data is tab-separated with at least 7 columns.');
            }
        }

        // Render Functions
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            if (state.view === 'login') {
                renderLoginView(app);
            } else if (state.view === 'teacher-login') {
                renderTeacherLogin(app);
            } else if (state.view === 'difficulty-select') {
                renderDifficultySelect(app);
            } else if (state.view === 'topic-select') {
                renderTopicSelect(app);
            } else if (state.view === 'teacher') {
                if (!state.teacherAuthenticated) {
                    state.view = 'teacher-login';
                    render();
                    return;
                }
                renderTeacherView(app);
            } else if (state.view === 'progress') {
                if (!state.teacherAuthenticated) {
                    state.view = 'teacher-login';
                    render();
                    return;
                }
                renderProgressView(app);
            } else if (state.view === 'analytics') {
                if (!state.teacherAuthenticated) {
                    state.view = 'teacher-login';
                    render();
                    return;
                }
                renderAnalyticsView(app);
            } else if (state.view === 'student') {
                renderStudentQuiz(app);
            }
        }

        function renderLoginView(container) {
            const div = document.createElement('div');
            div.className = 'min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 md:p-8 flex items-center justify-center';
            
            div.innerHTML = '<div class="max-w-md w-full">' +
                '<div class="bg-white rounded-lg shadow-lg p-8">' +
                '<h1 class="text-3xl font-bold text-purple-900 mb-2 text-center">Daily Ten</h1>' +
                '<p class="text-gray-600 mb-6 text-center">Maths Practice</p>' +
                '<div class="mb-6">' +
                '<label class="block text-sm font-medium mb-2">Enter your username:</label>' +
                '<input type="text" id="usernameInput" placeholder="e.g., Student42, Koala23" class="w-full p-3 border rounded-lg text-lg" autofocus />' +
                '<p class="text-xs text-gray-500 mt-2">Use your assigned username or nickname</p>' +
                '</div>' +
                '<button id="loginBtn" class="w-full bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-purple-700 transition">Start Practicing</button>' +
                '<button id="teacherBtn" class="w-full mt-4 text-sm text-gray-600 hover:text-gray-900">Teacher Login</button>' +
                '</div></div>';
            
            container.appendChild(div);
            
            document.getElementById('loginBtn').onclick = function() {
                state.usernameInput = document.getElementById('usernameInput').value;
                handleStudentLogin();
            };
            
            document.getElementById('usernameInput').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    state.usernameInput = document.getElementById('usernameInput').value;
                    handleStudentLogin();
                }
            };
            
            document.getElementById('teacherBtn').onclick = function() {
                state.view = 'teacher-login';
                render();
            };
        }

        function renderTeacherLogin(container) {
            const div = document.createElement('div');
            div.className = 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8 flex items-center justify-center';
            
            div.innerHTML = '<div class="max-w-md w-full">' +
                '<div class="bg-white rounded-lg shadow-lg p-8">' +
                '<h1 class="text-3xl font-bold text-indigo-900 mb-2 text-center">Teacher Login</h1>' +
                '<p class="text-gray-600 mb-6 text-center">Enter password to access teacher panel</p>' +
                '<div class="mb-6">' +
                '<label class="block text-sm font-medium mb-2">Password:</label>' +
                '<input type="password" id="teacherPasswordInput" placeholder="Enter teacher password" class="w-full p-3 border rounded-lg text-lg" autofocus />' +
                '</div>' +
                '<button id="teacherLoginBtn" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Access Teacher Panel</button>' +
                '<button id="backToStudentBtn" class="w-full mt-4 text-sm text-gray-600 hover:text-gray-900">‚Üê Back to Student Login</button>' +
                '</div></div>';
            
            container.appendChild(div);
            
            function attemptLogin() {
                const password = document.getElementById('teacherPasswordInput').value;
                if (password === TEACHER_PASSWORD) {
                    state.teacherAuthenticated = true;
                    state.view = 'teacher';
                    render();
                } else {
                    alert('Incorrect password. Please try again.');
                }
            }
            
            document.getElementById('teacherLoginBtn').onclick = attemptLogin;
            
            document.getElementById('teacherPasswordInput').onkeypress = function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            };
            
            document.getElementById('backToStudentBtn').onclick = function() {
                state.view = 'login';
                render();
            };
        }

        function renderDifficultySelect(container) {
            const div = document.createElement('div');
            div.className = 'min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 md:p-8';
            
            const levelData = [
                { key: 'easy', num: '1', emoji: '1Ô∏è‚É£', color: 'green', desc: 'Foundation practice' },
                { key: 'medium', num: '2', emoji: '2Ô∏è‚É£', color: 'yellow', desc: 'Intermediate practice' },
                { key: 'hard', num: '3', emoji: '3Ô∏è‚É£', color: 'red', desc: 'Advanced practice' }
            ];
            
            let html = '<div class="max-w-4xl mx-auto"><div class="bg-white rounded-lg shadow-lg p-6 md:p-8">' +
                '<div class="flex justify-between items-center mb-6">' +
                '<div><h1 class="text-2xl md:text-3xl font-bold text-purple-900">Daily Ten Maths Practice</h1>' +
                '<p class="text-sm text-gray-600">Welcome, ' + state.studentUsername + '!</p></div>' +
                '<button id="changeUserBtn" class="text-sm text-gray-600 hover:text-gray-900">Change User</button></div>' +
                '<h2 class="text-xl font-semibold mb-4 text-center">Choose Your Level</h2>' +
                '<div class="grid md:grid-cols-3 gap-6 mb-6">';
            
            levelData.forEach(function(level) {
                const disabled = state.questions[level.key].length < 10;
                html += '<button id="level-' + level.key + '" ' + (disabled ? 'disabled' : '') +
                    ' class="bg-' + level.color + '-500 hover:bg-' + level.color + '-600 disabled:bg-gray-300 text-white p-8 rounded-lg shadow-lg transition transform hover:scale-105 disabled:hover:scale-100 disabled:cursor-not-allowed">' +
                    '<div class="text-4xl mb-3">' + level.emoji + '</div>' +
                    '<h3 class="text-2xl font-bold mb-2">Level ' + level.num + '</h3>' +
                    '<p class="text-sm">' + level.desc + '</p>' +
                    '<p class="text-xs mt-3 opacity-75">' + state.questions[level.key].length + ' questions</p>' +
                    '</button>';
            });
            
            html += '</div>' +
                '<div class="border-t pt-4">' +
                '<p class="text-center text-gray-600 mb-3">Or practice a specific topic:</p>' +
                '<button id="topicPracticeBtn" class="w-full bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">' +
                'üìö Topic-Specific Practice</button>' +
                '</div>' +
                '</div></div>';
            
            div.innerHTML = html;
            container.appendChild(div);
            
            document.getElementById('changeUserBtn').onclick = function() {
                state.studentUsername = null;
                state.view = 'login';
                render();
            };
            
            document.getElementById('topicPracticeBtn').onclick = function() {
                state.view = 'topic-select';
                render();
            };
            
            levelData.forEach(function(level) {
                const btn = document.getElementById('level-' + level.key);
                if (btn && !btn.disabled) {
                    btn.onclick = function() { generateQuiz(level.key, null); };
                }
            });
        }

        function renderTopicSelect(container) {
            const div = document.createElement('div');
            div.className = 'min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4 md:p-8';
            
            const topics = getAllTopics();
            
            let html = '<div class="max-w-4xl mx-auto"><div class="bg-white rounded-lg shadow-lg p-6 md:p-8">' +
                '<div class="flex justify-between items-center mb-6">' +
                '<h1 class="text-2xl md:text-3xl font-bold text-purple-900">Topic Practice</h1>' +
                '<button id="backBtn" class="text-sm text-gray-600 hover:text-gray-900">‚Üê Back</button></div>' +
                '<p class="text-gray-600 mb-6">Choose a level and topic to practice</p>';
            
            const levels = [
                { key: 'easy', num: '1', emoji: '1Ô∏è‚É£' },
                { key: 'medium', num: '2', emoji: '2Ô∏è‚É£' },
                { key: 'hard', num: '3', emoji: '3Ô∏è‚É£' }
            ];
            
            levels.forEach(function(level) {
                html += '<div class="mb-6"><h3 class="text-lg font-bold mb-3 flex items-center gap-2">' +
                    level.emoji + ' Level ' + level.num + '</h3>' +
                    '<div class="grid md:grid-cols-3 gap-3">';
                
                topics.forEach(function(topic) {
                    const count = getQuestionsByLevelAndTopic(level.key, topic).length;
                    const disabled = count < 10;
                    
                    html += '<button id="topic-' + level.key + '-' + topic.replace(/\s+/g, '-') + '" ' +
                        (disabled ? 'disabled' : '') +
                        ' class="bg-white border-2 border-indigo-200 hover:border-indigo-400 hover:bg-indigo-50 disabled:border-gray-200 disabled:bg-gray-50 disabled:cursor-not-allowed p-4 rounded-lg transition text-left">' +
                        '<p class="font-semibold text-indigo-900">' + topic + '</p>' +
                        '<p class="text-xs text-gray-600 mt-1">' + count + ' question' + (count !== 1 ? 's' : '') + '</p>' +
                        '</button>';
                });
                
                html += '</div></div>';
            });
            
            html += '</div></div>';
            div.innerHTML = html;
            container.appendChild(div);
            
            document.getElementById('backBtn').onclick = function() {
                state.view = 'difficulty-select';
                render();
            };
            
            levels.forEach(function(level) {
                topics.forEach(function(topic) {
                    const btn = document.getElementById('topic-' + level.key + '-' + topic.replace(/\s+/g, '-'));
                    if (btn && !btn.disabled) {
                        btn.onclick = function() {
                            generateQuiz(level.key, topic);
                        };
                    }
                });
            });
        }

        function renderTeacherView(container) {
            const div = document.createElement('div');
            div.className = 'min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8';
            
            const totalQuestions = state.questions.easy.length + state.questions.medium.length + state.questions.hard.length;
            
            let html = '<div class="max-w-6xl mx-auto"><div class="bg-white rounded-lg shadow-lg p-8">' +
                '<h1 class="text-3xl font-bold text-indigo-900 mb-2">Daily Ten - Teacher Panel</h1>' +
                '<p class="text-gray-600 mb-6">Manage question banks and view student progress</p>' +
                '<div class="grid md:grid-cols-3 gap-4 mb-8">' +
                '<button id="launchStudentBtn" ' + (totalQuestions < 10 ? 'disabled' : '') +
                ' class="bg-indigo-600 text-white px-6 py-4 rounded-lg font-semibold text-lg hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition">üéì Launch Student Interface</button>' +
                '<button id="viewProgressBtn" class="bg-purple-600 text-white px-6 py-4 rounded-lg font-semibold text-lg hover:bg-purple-700 transition">üìä View Student Progress</button>' +
                '<button id="viewAnalyticsBtn" class="bg-green-600 text-white px-6 py-4 rounded-lg font-semibold text-lg hover:bg-green-700 transition">üìà Analytics Dashboard</button>' +
                '</div>' +
                '<div class="grid md:grid-cols-4 gap-4 mb-8">' +
                '<div class="bg-indigo-50 p-6 rounded-lg"><h2 class="text-lg font-semibold text-indigo-900 mb-2">Total Questions</h2><p class="text-4xl font-bold text-indigo-600">' + totalQuestions + '</p></div>' +
                '<div class="bg-green-50 p-6 rounded-lg"><h2 class="text-lg font-semibold text-green-900 mb-2">Level 1</h2><p class="text-4xl font-bold text-green-600">' + state.questions.easy.length + '</p></div>' +
                '<div class="bg-yellow-50 p-6 rounded-lg"><h2 class="text-lg font-semibold text-yellow-900 mb-2">Level 2</h2><p class="text-4xl font-bold text-yellow-600">' + state.questions.medium.length + '</p></div>' +
                '<div class="bg-red-50 p-6 rounded-lg"><h2 class="text-lg font-semibold text-red-900 mb-2">Level 3</h2><p class="text-4xl font-bold text-red-600">' + state.questions.hard.length + '</p></div>' +
                '</div>';
            
            const levels = [
                { key: 'easy', num: '1', emoji: '1Ô∏è‚É£' },
                { key: 'medium', num: '2', emoji: '2Ô∏è‚É£' },
                { key: 'hard', num: '3', emoji: '3Ô∏è‚É£' }
            ];
            
            levels.forEach(function(level) {
                html += '<div class="border-t pt-6 mb-6">' +
                    '<h3 class="text-xl font-bold mb-4 flex items-center gap-2">' + level.emoji + ' Level ' + level.num + ' Questions (' + state.questions[level.key].length + ')</h3>' +
                    '<div class="space-y-4">' +
                    '<div><label class="block text-sm font-medium mb-2">Add Questions to Level ' + level.num + '</label>' +
                    '<textarea id="questionInput-' + level.key + '" placeholder="Paste Level ' + level.num + ' questions here (Tab separated)" class="w-full h-32 p-3 border rounded-lg mb-3 font-mono text-sm"></textarea>' +
                    '<button id="addBtn-' + level.key + '" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">Add Questions</button></div>' +
                    '<div><h4 class="text-sm font-semibold mb-2">Preview (first 5)</h4>' +
                    '<div class="bg-gray-50 rounded-lg p-4 max-h-64 overflow-y-auto">';
                
                if (state.questions[level.key].length === 0) {
                    html += '<p class="text-gray-500 text-center py-4 text-sm">No Level ' + level.num + ' questions yet</p>';
                } else {
                    html += '<div class="space-y-2">';
                    state.questions[level.key].slice(0, 5).forEach(function(q, idx) {
                        html += '<div class="bg-white p-2 rounded border text-sm">' +
                            '<p class="font-semibold">' + (idx + 1) + '. ' + q.Question + '</p>' +
                            '<p class="text-xs text-gray-600 mt-1">Topic: ' + (q.Topic || 'General') + ' | Answer: ' + q.Answer + '</p>' +
                            '</div>';
                    });
                    if (state.questions[level.key].length > 5) {
                        html += '<p class="text-xs text-gray-500 text-center">...and ' + (state.questions[level.key].length - 5) + ' more</p>';
                    }
                    html += '</div>';
                }
                
                html += '</div></div>' +
                    '<button id="clearBtn-' + level.key + '" class="text-red-600 text-sm hover:underline">Clear Level ' + level.num + ' Questions</button>' +
                    '</div></div>';
            });
            
            html += '</div></div>';
            div.innerHTML = html;
            container.appendChild(div);
            
            document.getElementById('launchStudentBtn').onclick = function() {
                state.view = 'login';
                render();
            };
            
            document.getElementById('viewProgressBtn').onclick = async function() {
                await loadAllProgress();
                state.view = 'progress';
                render();
            };
            
            document.getElementById('viewAnalyticsBtn').onclick = async function() {
                await loadAllProgress();
                state.view = 'analytics';
                render();
            };
            
            levels.forEach(function(level) {
                document.getElementById('addBtn-' + level.key).onclick = function() {
                    const text = document.getElementById('questionInput-' + level.key).value;
                    if (text.trim()) {
                        addQuestionsFromText(level.key, text);
                        document.getElementById('questionInput-' + level.key).value = '';
                    }
                };
                
                document.getElementById('clearBtn-' + level.key).onclick = function() {
                    state.clearLevel = level.key;
                    state.showClearConfirm = true;
                    render();
                };
            });
            
            if (state.showClearConfirm) {
                renderClearModal(
